<section class="container center-horizontal">
  <div>
    <form autocomplete="off" class="row">
      <mat-form-field appearance="fill" id="kode" floatLabel="always">
        <mat-label>Kode</mat-label>
        <input
          id="code-input"
          type="text"
          aria-label="id"
          matInput
          spellcheck="false"
          [formControl]="codeControl"
          [matAutocomplete]="codeAuto"
          maxlength="3"
          #codeTrigger="matAutocompleteTrigger"
          [(ngModel)]="inputArr[0].value"
        />
        <button
          *ngIf="inputArr[0].value"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="clearThenTabTo(0, codeTrigger)"
          tabindex="-1"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-error *ngIf="codeControl.invalid">
          {{ codeControl.errors?.error }}
        </mat-error>

        <mat-autocomplete
          #codeAuto="matAutocomplete"
          (optionActivated)="inputArr[0].tempValue = $event.option?.value"
          (closed)="onClose(0)"
          (optionSelected)="optionSelected(0, $event.option.value, itemTrigger)"
        >
          <mat-option *ngFor="let option of codeOptions" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" id="item" floatLabel="always">
        <mat-label>Item</mat-label>
        <input
          id="item-input"
          type="text"
          aria-label="Item"
          matInput
          spellcheck="false"
          [formControl]="itemControl"
          [matAutocomplete]="itemAuto"
          [(ngModel)]="inputArr[1].value"
          #itemTrigger="matAutocompleteTrigger"
        />
        <button
          *ngIf="inputArr[1].value"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="clearThenTabTo(1, itemTrigger)"
          tabindex="-1"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete
          #itemAuto="matAutocomplete"
          (optionActivated)="inputArr[1].tempValue = $event.option?.value"
          (closed)="onClose(1)"
          (optionSelected)="
            optionSelected(1, $event.option.value, amountTrigger)
          "
        >
          <mat-option *ngFor="let option of itemOptions" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" id="amount" floatLabel="always">
        <mat-label>Aantal</mat-label>
        <input
          id="amount-input"
          type="number"
          matInput
          spellcheck="false"
          [formControl]="amountControl"
          [matAutocomplete]="amountAuto"
          [(ngModel)]="inputArr[2].value"
          #amountTrigger="matAutocompleteTrigger"
        />
        <button
          *ngIf="inputArr[2].value"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="clearThenTabTo(2, amountTrigger)"
          tabindex="-1"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete
          #amountAuto="matAutocomplete"
          (optionActivated)="inputArr[2].tempValue = $event.option?.value"
          (closed)="onClose(2)"
          (optionSelected)="optionSelected(2, $event.option.value)"
        >
          <mat-option *ngFor="let option of amountOptions" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="fill" id="price" floatLabel="always">
        <mat-label>Prys</mat-label>
        <span matPrefix>R &nbsp;</span>
        <input
          id="price-input"
          type="number"
          aria-label="Prys"
          matInput
          spellcheck="false"
          [formControl]="priceControl"
          [(ngModel)]="inputArr[3].value"
        />
      </mat-form-field>

      <mat-form-field appearance="fill" class="total" floatLabel="always">
        <mat-label>Totaal</mat-label>
        <input
          disabled
          matInput
          [value]="+inputArr[2].value * +inputArr[3].value | currency: 'R '"
        />
      </mat-form-field>

      <button
        class="add"
        type="button"
        mat-fab
        color="primary"
        aria-label="Add Item"
        (click)="addItem(codeTrigger)"
        [disabled]="isValidTransaction()"
      >
        <mat-icon>add</mat-icon>
      </button>
    </form>

    <div class="table-container">
      <table mat-table [dataSource]="list">
        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let element; index as i">{{ i + 1 }}</td>
        </ng-container>
        <ng-container matColumnDef="code">
          <th mat-header-cell *matHeaderCellDef>Kode</th>
          <td mat-cell *matCellDef="let element">{{ element.consignor_id }}</td>
        </ng-container>
        <ng-container matColumnDef="item">
          <th mat-header-cell *matHeaderCellDef>Item</th>
          <td mat-cell *matCellDef="let element">
            {{ element.item }}
          </td>
        </ng-container>
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Aantal</th>
          <td mat-cell *matCellDef="let element">{{ element.amount }}</td>
        </ng-container>
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Prys</th>
          <td
            mat-cell
            *matCellDef="let element"
            [ngClass]="element.classes ? element.classes(element) : ''"
          >
            {{ element.unit_price | currency: "R " }}
          </td>
        </ng-container>
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Totaal</th>
          <td
            mat-cell
            *matCellDef="let element; index as i"
            [ngStyle]="{
              color: element.unit_price > 0 ? 'var(--green)' : 'var(--red)'
            }"
          >
            {{ element.amount * element.unit_price | currency: "R " }}
            <button
              matSuffix
              mat-icon-button
              aria-label="Clear"
              (click)="popItem(i)"
            >
              <mat-icon>close</mat-icon>
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="complete-transaction">
          <td mat-footer-cell *matFooterCellDef colspan="4">
            <button
              mat-flat-button
              color="warn"
              (click)="previewInvoice()"
              [disabled]="list.length === 0"
            >
              <mat-icon>picture_as_pdf</mat-icon>
              Faktuur
            </button>
            <!-- color="accent" -->
            <button
              mat-flat-button
              (click)="complete()"
              [disabled]="list.length === 0"
            >
              <mat-icon>done</mat-icon>
              Voltooi Transaksie
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="total-label">
          <td mat-footer-cell *matFooterCellDef colspan="1" class="txt-lg">
            Totaal:
          </td>
        </ng-container>

        <ng-container matColumnDef="total-calc">
          <td mat-footer-cell *matFooterCellDef colspan="1" class="txt-lg">
            {{ transaction.getTotal() | currency: "R " }}
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedColumns; sticky: true"
        ></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        <tr
          mat-footer-row
          *matFooterRowDef="['complete-transaction']; sticky: true"
        ></tr>
        <tr mat-footer *matFooterRowDef="['total-label']; sticky: true"></tr>
        <tr mat-footer *matFooterRowDef="['total-calc']; sticky: true"></tr>
      </table>
    </div>
  </div>
</section>
<app-invoice
  (closed)="showInvoice = false"
  *ngIf="invoiceData && showInvoice"
  [data]="invoiceData"
></app-invoice>
